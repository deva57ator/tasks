const fs = require('node:fs');
const path = require('node:path');

function parse(src) {
  const result = {};
  const lines = src.split(/\r?\n/);
  for (const line of lines) {
    if (!line || line.trim().length === 0) continue;
    if (line.trim().startsWith('#')) continue;
    const match = /^([^=]+?)\s*=\s*(.*)$/.exec(line);
    if (!match) continue;
    let [, key, value] = match;
    key = key.trim();
    value = value.trim();
    if ((value.startsWith('"') && value.endsWith('"')) || (value.startsWith("'") && value.endsWith("'"))) {
      value = value.slice(1, -1);
    }
    result[key] = value;
  }
  return result;
}

function config(options = {}) {
  const envPath = options.path || path.resolve(process.cwd(), '.env');
  try {
    const content = fs.readFileSync(envPath, 'utf8');
    const parsed = parse(content);
    for (const [key, value] of Object.entries(parsed)) {
      if (process.env[key] === undefined) {
        process.env[key] = value;
      }
    }
    return { parsed };
  } catch (error) {
    if (options.silent) return { error };
    if (error.code !== 'ENOENT') {
      throw error;
    }
    return { error };
  }
}

module.exports = { config, parse };
