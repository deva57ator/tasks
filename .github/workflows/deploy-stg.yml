name: Deploy STG (auto on push)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  deploy-stg:
    runs-on: ubuntu-latest

    env:
      SSH_HOST: ${{ secrets.DEPLOY_HOST }}
      SSH_USER: ${{ secrets.DEPLOY_USER }}
      SSH_PORT: ${{ secrets.DEPLOY_PORT }}
      PATH_STG:  ${{ secrets.DEPLOY_PATH_STG }}      # напр. /srv/tasks-stg
      WEB_STG:   ${{ secrets.DEPLOY_WEB_PATH_STG }}  # напр. /var/www/tasks-stg

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH agent (SSH_KEY)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.SSH_KEY }}

      - name: Add host key (known_hosts)
        run: |
          : "${SSH_PORT:=22}"
          mkdir -p ~/.ssh
          ssh-keyscan -p "${SSH_PORT}" -H "${SSH_HOST}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      # === API → STG ===
      - name: Copy API to STG (/srv/tasks-stg/_tmp → /srv/tasks-stg/apps/api)
        run: |
          : "${SSH_PORT:=22}"
          rsync -av --delete -e "ssh -p ${SSH_PORT}" \
            --filter='merge infra/rsync/api.filter' \
            ./ "${SSH_USER}@${SSH_HOST}:${PATH_STG}/_tmp/"

          ssh -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" "set -eu
            DEPLOY_PATH='${PATH_STG}'
            mkdir -p \"\$DEPLOY_PATH/apps\"
            rm -rf \"\$DEPLOY_PATH/apps/api\"
            mv \"\$DEPLOY_PATH/_tmp/apps/api\" \"\$DEPLOY_PATH/apps/\"
            rm -rf \"\$DEPLOY_PATH/_tmp\"/*
          "

      # === WEB → STG ===
      - name: Copy WEB to STG webroot (/var/www/tasks-stg)
        run: |
          : "${SSH_PORT:=22}"
          ssh -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" "mkdir -p '${WEB_STG}'"
          rsync -av --delete -e "ssh -p ${SSH_PORT}" \
            apps/web/ "${SSH_USER}@${SSH_HOST}:${WEB_STG}/"

      # === deps, migrate, restart ===
      - name: Install deps, migrate, restart STG
        shell: bash
        run: |
          : "${SSH_PORT:=22}"
          ssh -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" PATH_STG="${PATH_STG}" bash -seu <<'EOSH'
          set -euo pipefail

          DEPLOY_PATH="$PATH_STG"

          cd "$DEPLOY_PATH/apps/api"

          if [ -f package-lock.json ]; then
            npm ci --omit=dev --no-audit --no-fund
          else
            npm install --omit=dev --no-audit --no-fund
          fi

          # Явно говорим миграциям, где лежит стейдж-база
          DB_PATH="$DEPLOY_PATH/data/tasks.sqlite" npm run migrate

          # Рестарт сервиса
          sudo -n systemctl daemon-reload || true
          sudo -n systemctl restart tasks-stg

          # Небольшая пауза и жёсткая проверка, что сервис действительно активен
          sleep 3
          if ! systemctl is-active --quiet tasks-stg; then
            echo "tasks-stg is not active after restart" >&2
            systemctl status --no-pager tasks-stg || true
            journalctl -u tasks-stg --since "5 minutes ago" --no-pager || true
            exit 1
          fi

          # Для логов в job, но не ломаем пайплайн
          systemctl status --no-pager tasks-stg || true
          EOSH

      - name: Health check (STG)
        shell: bash
        run: |
          # Делаем health-check с ретраями, чтобы успел подняться nginx+API
          URL='https://parkhomenko.space/tasks-stg/api/health'

          echo "Checking health: $URL"

          curl --fail --show-error \
               --retry 10 \
               --retry-delay 5 \
               --retry-all-errors \
               "$URL" >/dev/null
