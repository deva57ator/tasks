name: Deploy — staging (tasks)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: deploy-stg
  cancel-in-progress: false

jobs:
  deploy-stg:
    runs-on: ubuntu-latest
    environment: staging

    env:
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_PORT: ${{ secrets.SSH_PORT }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -p "${SSH_PORT:-22}" "$SSH_HOST" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Rsync API → /srv/tasks-stg
        run: |
          rsync -az --delete \
            -e "ssh -p ${SSH_PORT:-22}" \
            --filter="merge infra/rsync/api.filter" \
            ./ "${SSH_USER}@${SSH_HOST}:/srv/tasks-stg/"

      - name: Rsync WEB (static) → /var/www/tasks-stg
        run: |
          rsync -az --delete \
            -e "ssh -p ${SSH_PORT:-22}" \
            --filter="merge infra/rsync/web.filter" \
            ./ "${SSH_USER}@${SSH_HOST}:/var/www/tasks-stg/"

      - name: Install deps (API) + migrate (stg, Node 20 via nvm)
        run: |
          ssh -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" 'bash -leo pipefail << "REMOTE"
          set -Eeuo pipefail

          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
          nvm use 20 >/dev/null

          cd /srv/tasks-stg/apps/api

          # предпочтительно ci, если lock совпадает; fallback на install
          (npm ci --omit=dev) || npm install --omit=dev

          # прогон миграций с окружением
          set -a
          [ -f /etc/tasks-stg.env ] && . /etc/tasks-stg.env
          set +a

          npm run migrate --if-present
          REMOTE'

      - name: Restart systemd service (tasks-stg)
        run: |
          ssh -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" '
            sudo systemctl daemon-reload || true
            sudo systemctl restart tasks-stg
          '

      - name: Health check (https://parkhomenko.space/tasks-stg/api/health)
        run: |
          curl -fsS https://parkhomenko.space/tasks-stg/api/health | jq .
