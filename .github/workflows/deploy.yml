name: Deploy tasks (stg & prod)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SSH_PORT: ${{ secrets.DEPLOY_PORT || 22 }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.SSH_KEY }}

      - name: Add host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${{ env.SSH_PORT }}" -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      # ===== API → STG (/srv/tasks-stg) =====
      - name: Copy API to STG
        run: |
          rsync -av --delete -e "ssh -p $SSH_PORT" \
            --filter='merge infra/rsync/.rsync-filter-api' \
            ./ "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH_STG }}-tmp/"
          ssh -p "$SSH_PORT" "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" '
            set -e
            rm -rf "${DEPLOY_PATH}/apps/api"
            mkdir -p "${DEPLOY_PATH}/apps"
            mv "${DEPLOY_PATH}-tmp/apps/api" "${DEPLOY_PATH}/apps/"
            rm -rf "${DEPLOY_PATH}-tmp"
          ' DEPLOY_PATH="${{ secrets.DEPLOY_PATH_STG }}"

      # ===== API → PROD (/srv/tasks-prod) =====
      - name: Copy API to PROD
        run: |
          rsync -av --delete -e "ssh -p $SSH_PORT" \
            --filter='merge infra/rsync/.rsync-filter-api' \
            ./ "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH_PROD }}-tmp/"
          ssh -p "$SSH_PORT" "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" '
            set -e
            rm -rf "${DEPLOY_PATH}/apps/api"
            mkdir -p "${DEPLOY_PATH}/apps"
            mv "${DEPLOY_PATH}-tmp/apps/api" "${DEPLOY_PATH}/apps/"
            rm -rf "${DEPLOY_PATH}-tmp"
          ' DEPLOY_PATH="${{ secrets.DEPLOY_PATH_PROD }}"

      # ===== WEB → STG (/var/www/tasks-stg) =====
      - name: Copy WEB to STG webroot
        run: |
          rsync -av --delete -e "ssh -p $SSH_PORT" \
            --filter='merge infra/rsync/.rsync-filter-web' \
            ./ "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_WEB_PATH_STG }}/"

      # ===== WEB → PROD (/var/www/tasks-prod) =====
      - name: Copy WEB to PROD webroot
        run: |
          rsync -av --delete -e "ssh -p $SSH_PORT" \
            --filter='merge infra/rsync/.rsync-filter-web' \
            ./ "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_WEB_PATH_PROD }}/"

      # ===== post-deploy: npm ci, migrate, restart =====
      - name: Install & migrate & restart (STG)
        run: |
          ssh -p "$SSH_PORT" "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" '
            set -e
            cd "${DEPLOY_PATH}/apps/api"
            npm ci --omit=dev
            npm run migrate
            sudo systemctl restart tasks-stg
          ' DEPLOY_PATH="${{ secrets.DEPLOY_PATH_STG }}"

      - name: Install & migrate & restart (PROD)
        run: |
          ssh -p "$SSH_PORT" "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" '
            set -e
            cd "${DEPLOY_PATH}/apps/api"
            npm ci --omit=dev
            npm run migrate
            sudo systemctl restart tasks-prod
          ' DEPLOY_PATH="${{ secrets.DEPLOY_PATH_PROD }}"
