name: Promote to PROD (manual)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Коммит/ветка/тег для промоута (по умолчанию — текущий main)"
        required: false
        default: ""

jobs:
  deploy-prod:
    runs-on: ubuntu-latest

    env:
      SSH_HOST: ${{ secrets.DEPLOY_HOST }}
      SSH_USER: ${{ secrets.DEPLOY_USER }}
      SSH_PORT: ${{ secrets.DEPLOY_PORT }}
      PATH_PROD: ${{ secrets.DEPLOY_PATH_PROD }}      # напр. /srv/tasks-prod
      WEB_PROD:  ${{ secrets.DEPLOY_WEB_PATH_PROD }}  # напр. /var/www/tasks-prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref != '' && inputs.ref || 'main' }}

      - name: Setup SSH agent (SSH_KEY)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.SSH_KEY }}

      - name: Add host key (known_hosts)
        run: |
          : "${SSH_PORT:=22}"
          mkdir -p ~/.ssh
          # Если у домена есть AAAA, принудим IPv4 (AddressFamily=inet ниже)
          ssh-keyscan -p "${SSH_PORT}" -H "${SSH_HOST}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Test SSH connectivity (verbose)
        run: |
          : "${SSH_PORT:=22}"
          ssh -vvv -o AddressFamily=inet \
              -o ServerAliveInterval=30 -o ServerAliveCountMax=2 \
              -o ConnectTimeout=15 -p "${SSH_PORT}" \
              "${SSH_USER}@${SSH_HOST}" "echo ok"

      # === API → PROD ===
      - name: Copy API to PROD (/srv/tasks-prod/_tmp → /srv/tasks-prod/apps/api)
        run: |
          : "${SSH_PORT:=22}"

          # 1. Копируем весь репозиторий в внутренний _tmp, как на STG
          rsync -av --delete \
            -e "ssh -p ${SSH_PORT} -o AddressFamily=inet -o ServerAliveInterval=30 -o ServerAliveCountMax=2 -o ConnectTimeout=15" \
            --filter='merge infra/rsync/api.filter' \
            ./ "${SSH_USER}@${SSH_HOST}:${PATH_PROD}/_tmp/"

          # 2. На сервере перекладываем apps/api на место и чистим _tmp
          ssh -o AddressFamily=inet \
              -o ServerAliveInterval=30 -o ServerAliveCountMax=2 \
              -o ConnectTimeout=15 -p "${SSH_PORT}" \
              "${SSH_USER}@${SSH_HOST}" "set -eu
            DEPLOY_PATH='${PATH_PROD}'
            mkdir -p \"\$DEPLOY_PATH/apps\"
            rm -rf \"\$DEPLOY_PATH/apps/api\"
            mv \"\$DEPLOY_PATH/_tmp/apps/api\" \"\$DEPLOY_PATH/apps/\"
            rm -rf \"\$DEPLOY_PATH/_tmp\"/*
          "

      # === WEB → PROD ===
      - name: Copy WEB to PROD webroot (/var/www/tasks-prod)
        run: |
          : "${SSH_PORT:=22}"
          rsync -av --delete \
            -e "ssh -p ${SSH_PORT} -o AddressFamily=inet -o ServerAliveInterval=30 -o ServerAliveCountMax=2 -o ConnectTimeout=15" \
            apps/web/ "${SSH_USER}@${SSH_HOST}:${WEB_PROD}/"

      # === deps, migrate, restart ===
      - name: Install deps, migrate, restart PROD
        run: |
          : "${SSH_PORT:=22}"
          ssh -o AddressFamily=inet \
              -o ServerAliveInterval=30 -o ServerAliveCountMax=2 \
              -o ConnectTimeout=15 -p "${SSH_PORT}" \
              "${SSH_USER}@${SSH_HOST}" "set -eu
            cd '${PATH_PROD}/apps/api'
            if [ -f package-lock.json ]; then
              npm ci --omit=dev --no-audit --no-fund
            else
              npm install --omit=dev --no-audit --no-fund
            fi
            npm run migrate
            sudo -n systemctl daemon-reload || true
            sudo -n systemctl restart tasks-prod
            sleep 3
            if ! systemctl is-active --quiet tasks-prod; then
              echo "tasks-prod is not active after restart" >&2
              systemctl status --no-pager tasks-prod || true
              journalctl -u tasks-prod --since "5 minutes ago" --no-pager || true
              exit 1
            fi

            curl -fsS --retry 10 --retry-connrefused --retry-delay 1 http://127.0.0.1:3101/api/health >/dev/null
            systemctl status --no-pager tasks-prod | tail -n +1 || true
          "

      - name: Health check (PROD)
        shell: bash
        run: |
          URL='https://parkhomenko.space/tasks/api/health'
          echo "Checking health: $URL"
      
          curl --fail --show-error \
               --retry 10 \
               --retry-delay 5 \
               --retry-all-errors \
               "$URL" >/dev/null
