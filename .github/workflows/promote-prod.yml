name: Promote to PROD (manual)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Коммит/ветка/тег для промоута (по умолчанию — текущий main)"
        required: false
        default: ""

jobs:
  deploy-prod:
    runs-on: ubuntu-latest

    env:
      SSH_HOST: ${{ secrets.DEPLOY_HOST }}
      SSH_USER: ${{ secrets.DEPLOY_USER }}
      SSH_PORT: ${{ secrets.DEPLOY_PORT }}
      PATH_PROD: ${{ secrets.DEPLOY_PATH_PROD }}      # напр. /srv/tasks-prod
      WEB_PROD:  ${{ secrets.DEPLOY_WEB_PATH_PROD }}  # напр. /var/www/tasks-prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref != '' && inputs.ref || 'main' }}

      - name: Setup SSH agent (SSH_KEY)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.SSH_KEY }}

      - name: Add host key (known_hosts)
        shell: bash
        run: |
          : "${SSH_PORT:=22}"
          mkdir -p ~/.ssh
          ssh-keyscan -p "${SSH_PORT}" -H "${SSH_HOST}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      # (опционально) smoke STG перед промоутом — если не ок, роняем job
      - name: Pre-check STG health
        shell: bash
        run: |
          curl -fsS https://parkhomenko.space/tasks-stg/api/health >/dev/null

      # === API → PROD ===
      - name: Copy API to PROD (/srv/tasks-prod)
        shell: bash
        run: |
          : "${SSH_PORT:=22}"
          rsync -av --delete -e "ssh -p ${SSH_PORT}" \
            --filter='merge infra/rsync/api.filter' \
            ./ "${SSH_USER}@${SSH_HOST}:${PATH_PROD}-tmp/"

          ssh -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" 'bash -seu <<'\'EOSH'\'
            DEPLOY_PATH="${PATH_PROD}"
            rm -rf "$DEPLOY_PATH/apps/api"
            install -d "$DEPLOY_PATH/apps"
            mv "'"'"${PATH_PROD}"'"'"-tmp/apps/api" "$DEPLOY_PATH/apps/"
            rm -rf "'"'"${PATH_PROD}"'"'"-tmp"

            # shim для systemd
            install -d "$DEPLOY_PATH/src"
            cat >"$DEPLOY_PATH/src/server.js" <<'JS'
require('../apps/api/src/server');
JS

            # зависимости видны из корня
            ln -sfn "$DEPLOY_PATH/apps/api/node_modules" "$DEPLOY_PATH/node_modules"
EOSH'

      # === WEB → PROD ===
      - name: Copy WEB to PROD webroot (/var/www/tasks-prod)
        shell: bash
        run: |
          : "${SSH_PORT:=22}"
          rsync -av --delete -e "ssh -p ${SSH_PORT}" \
            apps/web/ "${SSH_USER}@${SSH_HOST}:${WEB_PROD}/"


      # === deps, migrate, restart ===
      - name: Install deps, migrate, restart PROD
        shell: bash
        run: |
          : "${SSH_PORT:=22}"
          ssh -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" 'bash -seu <<'\'EOSH'\'
            cd "'"'"${PATH_PROD}"'"'"/apps/api"
            npm ci --omit=dev --no-audit --no-fund || npm install --omit=dev --no-audit --no-fund
            npm run migrate
            sudo -n systemctl daemon-reload || true
            sudo -n systemctl restart tasks-prod
            for i in 1 2 3 4 5; do
              sleep 2
              curl -fsS http://127.0.0.1:3101/api/health >/dev/null && exit 0 || true
            done
            systemctl status --no-pager tasks-prod || true
            journalctl -u tasks-prod -n 100 --no-pager || true
            exit 1
EOSH'

      - name: Health check PROD
        shell: bash
        run: |
          for i in 1 2 3; do
            curl -fsS https://parkhomenko.space/tasks/api/health >/dev/null && exit 0 || true
            sleep 2
          done
          exit 22
